<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Telemetria</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.3/socket.io.min.js"
            integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
            crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-2.16.1.min.js"></script>

    <style>
        body {
            /*background-color: #121212 !important;*/
            position: absolute;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #indicatori {
            position: relative;
            height: 17.5%;
            margin: 2%;
            display: flex;
            justify-content: space-around;
            overflow-x: auto;
        }

        #indicatori > div {
            position: relative;
            height: 100%;
            width: 15%;
        }

        .new {
            box-sizing: border-box;
            text-align: center;
            display: table;
            border: 1px dashed grey;
            border-radius: 25px;
        }

        .new > .mdc-fab {
            top: 50%;
            transform: translateY(-50%);
        }

        #grafici {
            position: relative;
            width: 96%;
            height: 60%;
            left: 2%;
            top: 2%;
            display: flex;
            flex-flow: row wrap;
            justify-content: space-around;
        }

        #grafici > div {
            position: relative;
            height: 100%;
            width: 45%;
        }

        .chart {
            margin-bottom: 2%;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }
    </style>
</head>
<body>

<div id="indicatori">
    <div class="new">
        <button id="newInd" class="mdc-fab mdc-fab--extended" aria-label="New">
            <div class="mdc-fab__ripple"></div>
            <span id="fabIcon" class="mdc-fab__icon material-icons">add</span>
            <span class="mdc-fab__label">New indicator</span>
        </button>
    </div>
</div>

<div id="grafici">
    <div class="new">
        <button id="newChart" class="mdc-fab mdc-fab--extended" data-bs-toggle="modal" data-bs-target="#optionsModal"
                aria-label="New">
            <div class="mdc-fab__ripple"></div>
            <span id="fabIcon" class="mdc-fab__icon material-icons">add</span>
            <span class="mdc-fab__label">New plot</span>
        </button>
    </div>
</div>

<div class="modal fade" id="optionsModal" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable ">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">New chart</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="options">
                    <div id="yOptions">
                        <h3>Options</h3>
                        <ul id="yOptionsCheckBoxes">
                            <li id="temperature">
                                <div class="mdc-form-field">
                                    <div class="mdc-checkbox">
                                        <input type="checkbox" id="temperature-indeterminate-checkbox"
                                               class="mdc-checkbox__native-control" data-indeterminate="false"/>
                                        <div class="mdc-checkbox__background">
                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                            </svg>
                                            <div class="mdc-checkbox__mixedmark"></div>
                                        </div>
                                        <div class="mdc-checkbox__ripple"></div>
                                    </div>
                                    <label for="temperature-indeterminate-checkbox"
                                           id="temperature-indeterminate-checkbox-label">Temperature</label>
                                </div>
                                <ul id="temperatureCheckboxes">
                                    <li>
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox" id="motor-temperature-indeterminate-checkbox"
                                                       class="mdc-checkbox__native-control" data-indeterminate="false"/>
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path" fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                                <div class="mdc-checkbox__ripple"></div>
                                            </div>
                                            <label for="motor-temperature-indeterminate-checkbox"
                                                   id="temperature-indeterminate-checkbox-label">Motor
                                                temperature</label>
                                        </div>
                                        <ul id="temperatureMotorsCheckBoxes">
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.motors.fl"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.motors.fl">Front left motor
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.motors.fr"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.motors.fr">Front right motor
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.motors.rl"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.motors.rl">Rear left motor
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.motors.rr"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.motors.fl">Rear right motor
                                                        temperature</label>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox" id="cooling-temperature-indeterminate-checkbox"
                                                       class="mdc-checkbox__native-control" data-indeterminate="false"/>
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path" fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                                <div class="mdc-checkbox__ripple"></div>
                                            </div>
                                            <label for="cooling-temperature-indeterminate-checkbox"
                                                   id="temperature-indeterminate-checkbox-label">Cooling
                                                temperature</label>
                                        </div>
                                        <ul id="temperatureCoolingCheckBoxes">
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.cooling.preRad"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.motors.fl">preRad cooling
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.cooling.preMot"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.cooling.preMot">preMot cooling
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.cooling.preCold"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.cooling.preCold">preCold cooling
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.cooling.postMot"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.cooling.postMot">postMot cooling
                                                        temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.cooling.postCold"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.cooling.postCold">postCold cooling
                                                        temperature</label>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox" id="hv-temperature-indeterminate-checkbox"
                                                       class="mdc-checkbox__native-control" data-indeterminate="false"/>
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path" fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                                <div class="mdc-checkbox__ripple"></div>
                                            </div>
                                            <label for="hv-temperature-indeterminate-checkbox"
                                                   id="temperature-indeterminate-checkbox-label">High Voltage
                                                temperature</label>
                                        </div>
                                        <ul id="temperatureCoolingCheckBoxes">
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.hv.high"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.hv.high">HV high temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.hv.low"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.hv.low">HV low temperature</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="temperature.hv.avg"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="temperature.hv.avg">Hv avg temperature</label>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li id="voltage">
                                <div class="mdc-form-field">
                                    <div class="mdc-checkbox">
                                        <input type="checkbox" id="voltage-indeterminate-checkbox"
                                               class="mdc-checkbox__native-control" data-indeterminate="false"/>
                                        <div class="mdc-checkbox__background">
                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                            </svg>
                                            <div class="mdc-checkbox__mixedmark"></div>
                                        </div>
                                        <div class="mdc-checkbox__ripple"></div>
                                    </div>
                                    <label for="voltage-indeterminate-checkbox"
                                           id="voltage-indeterminate-checkbox-label">Voltage</label>
                                </div>
                                <ul id="voltageCheckbox">
                                    <li>
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox" id="hv-voltage-indeterminate-checkbox"
                                                       class="mdc-checkbox__native-control" data-indeterminate="false"/>
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path" fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                                <div class="mdc-checkbox__ripple"></div>
                                            </div>
                                            <label for="hv-voltage-indeterminate-checkbox"
                                                   id="temperature-indeterminate-checkbox-label">HV voltage</label>
                                        </div>
                                        <ul id="temperatureCoolingCheckBoxes">
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="voltage.hv.high"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="voltage.hv.high">HV high voltage</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="voltage.hv.low"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="voltage.hv.low">HV low voltage</label>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="mdc-form-field">
                                                    <div class="mdc-checkbox">
                                                        <input type="checkbox" class="mdc-checkbox__native-control"
                                                               id="voltage.hv.avg"/>
                                                        <div class="mdc-checkbox__background">
                                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                            </svg>
                                                            <div class="mdc-checkbox__mixedmark"></div>
                                                        </div>
                                                        <div class="mdc-checkbox__ripple"></div>
                                                    </div>
                                                    <label for="voltage.hv.avg">Hv avg voltage</label>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="initChart" type="button" class="btn btn-primary">Load chart</button>
            </div>
        </div>
    </div>
</div>

<script src="/main.js"></script>
<script>
    const START = Date.now();
    const MAX_POINT = 60; // 10 log/s * 60 s/min = 60 logs
    let socket = io();

    let i = 0;
    /*socket.on('data', function (data) {
        if (window.plotArray.length > 0) {
            window.plotArray.forEach((value) => {
                let y = [];
                let x = [];
                let now = Date.now();
                value[2].forEach((value) => {
                    y.push([value.split('.').reduce((o, i) => o[i], data)]);
                    x.push([now - START]);
                })

                Plotly.extendTraces(
                    'chart' + value[0],
                    {
                        y: y,
                        x: x
                    },
                    [...Array(value[2].length).keys()]
                );
            });
        }
    });*/
</script>
<script>
    new MutationObserver(mutationRecords => {
        let el = document.getElementsByClassName('chart');
        for (let i = 0; i < el.length; i++) {
            el[i].addEventListener('dragstart', handleStart, false);
            el[i].addEventListener('dragover', handleOver, false);
            el[i].addEventListener('drop', handleDrop, false);
        }
    }).observe(document.getElementById('grafici'), {childList: true});

    let dragSource;

    function getChildrenIndex(element) {
        let parent = element.parentNode;
        return Array.prototype.indexOf.call(parent.children, element);
    }

    function handleStart(event) {
        dragSource = this;
        console.log('start', dragSource);
        event.dataTransfer.effectAllowed = 'move';
    }

    function handleOver(event) {
        event.dataTransfer.dropEffect = 'move';
        event.preventDefault();
    }

    function handleDrop(event) {
        event.stopPropagation();
        if (dragSource !== this) {
            console.log('end', this);
            let prevIndex = getChildrenIndex(dragSource);
            let newIndex = getChildrenIndex(this);

            if (prevIndex > newIndex)
                document.getElementById('grafici').insertBefore(dragSource, this);
            else
                document.getElementById('grafici').insertBefore(dragSource, this.nextSibling);
        }
        event.preventDefault();
    }
</script>
</body>
</html>